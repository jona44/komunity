{% load static %}

<!-- All Comments Modal -->
<dialog id="all_comments_modal_{{ post.id }}" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-white rounded-xl max-w-3xl max-h-[80vh]">
    <!-- Modal Header -->
    <div class="flex items-center justify-between mb-4 sticky top-0 bg-white pb-3 border-b">
      <h3 class="text-xl font-bold text-gray-900">All Condolence Messages ({{ post.comment_set.count }})</h3>
      <form method="dialog">
        <button class="btn btn-sm btn-square btn-ghost">âœ•</button>
      </form>
    </div>

    <!-- Modal Body - Scrollable -->
    <div class="space-y-3 overflow-y-auto max-h-[60vh]">
      {% for comment in post.comment_set.all %}
      <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
        <div class="flex gap-3">
          <div class="avatar">
            <div class="w-8 h-8 rounded-full">
              {% if comment.author.profile_picture %}
                <img src="{{ comment.author.profile_picture.url }}">
              {% else %}
                <div class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center text-white text-xs font-semibold">
                  {{ comment.author.first_name|first|default:"U" }}{{ comment.author.surname|first|default:"" }}
                </div>
              {% endif %}
            </div>
          </div>

          <div class="flex-1">
            <div class="flex justify-between">
              <div class="font-bold text-sm">{{ comment.author.full_name }}</div>
              <div class="text-xs text-gray-400">{{ comment.created_at|timesince }}</div>
            </div>

            <p class="text-sm text-gray-700 mt-1">{{ comment.content }}</p>

            <div class="flex items-center gap-2 mt-2">
              <button onclick="document.getElementById('add_reply_modal_{{ comment.id }}').showModal(); document.getElementById('all_comments_modal_{{ post.id }}').close();"
                 class="text-xs text-orange-600 hover:underline flex items-center gap-1">
                <span class="material-icons" style="font-size: 12px;">reply</span>
                Reply
              </button>

              {% if user == comment.author %}
                <a href="{% url 'edit_comment' comment.id %}" class="text-xs text-gray-500">Edit</a>
                <a href="{% url 'delete_comment' comment.id %}" class="text-xs text-red-500">Delete</a>
              {% endif %}
            </div>

            {% if comment.replies.exists %}
            <div class="ml-4 mt-2 space-y-2 border-l-2 border-gray-100 pl-3">
              {% for reply in comment.replies.all %}
              <div class="bg-white p-2 rounded text-sm">
                <div class="flex gap-2">
                  <div class="avatar">
                    <div class="w-6 h-6 rounded-full">
                      {% if reply.author.profile_picture %}
                        <img src="{{ reply.author.profile_picture.url }}">
                      {% else %}
                        <div class="w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center text-white text-xs font-semibold">
                          {{ reply.author.first_name|first|default:"U" }}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  <div>
                    <span class="font-bold text-xs">{{ reply.author.full_name }}</span>
                    <p class="text-gray-600">{{ reply.content }}</p>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Modal Actions -->
    <div class="modal-action sticky bottom-0 bg-white pt-3 border-t">
      <form method="dialog">
        <button class="btn bg-gray-500 hover:bg-gray-600 text-white rounded-full">Close</button>
      </form>
    </div>
  </div>
  
  <!-- Modal Backdrop -->
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
