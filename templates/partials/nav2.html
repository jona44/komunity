{% load static %}

<nav class="  w-full z-50 top-0 start-0 border-b border-gray-200 ">
  <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-2">
    
    <!-- Logo & Group Switcher -->
    <div class="flex items-center gap-4">
        <a href="{% url 'home' %}" class="flex items-center space-x-3 rtl:space-x-reverse">
            <img src="{% static 'images/chema.png' %}" width="150" height="40" alt="Chema Logo" class="h-10 w-auto" />
        </a>

        {% if user.is_authenticated and groups %}
        <div class="relative">
            <button id="group-switcher-button" 
                    class="flex items-center gap-2 px-3 py-1.5 bg-gray-50 hover:bg-gray-100 rounded-lg text-sm font-semibold text-gray-700 transition-all border border-gray-200">
                <span class="max-w-[120px] truncate">{% if active_group %}{{ active_group.name }}{% else %}Select Group{% endif %}</span>
                <span class="material-icons text-sm opacity-50">expand_more</span>
            </button>
            <div id="group-switcher-dropdown" 
                 class="absolute left-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 hidden z-[60]">
                <div class="p-2 space-y-1 max-h-64 overflow-y-auto">
                    {% for group in groups %}
                    <a href="{% url 'toggle_group' group.id %}" 
                       class="block px-3 py-2 rounded-lg text-sm {% if group == active_group %}bg-blue-50 text-blue-700 font-bold{% else %}text-gray-700 hover:bg-gray-50{% endif %} transition-colors">
                        {{ group.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- User Menu & Mobile Toggle -->
    <div class="flex items-center md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse relative">
        
        <!-- User Profile Button -->
        <button type="button" 
           class="flex items-center space-x-2 text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-300 pr-2"
           id="user-menu-button" 
           aria-expanded="false">
          <span class="sr-only">Open user menu</span>
          {% if user.profile.profile_picture %}
            <img class="w-10 h-10 rounded-full object-cover" 
            src="{{ user.profile.profile_picture.url }}" 
            width="10" height="10"  
            alt="user photo">
          {% else %}
            <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white text-xs font-semibold">
              {{ user.profile.first_name|first|default:"U" }}{{ user.profile.last_name|first|default:"" }}
            </div>
          {% endif %}
          
          {% if user_role %}
            <span class="hidden md:inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                {% if user_role == 'admin' %}bg-purple-100 text-purple-800
                {% elif user_role == 'moderator' %}bg-green-100 text-green-800
                {% else %}bg-blue-100 text-blue-800{% endif %}">
              {{ user_role|title }}
            </span>
          {% endif %}
        </button>

        <!-- User Dropdown -->
        <div class="z-50 hidden absolute right-0 top-full mt-2 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow-lg w-48" 
             id="user-dropdown">
          <div class="px-4 py-3">
            <span class="block text-sm text-gray-900">{{ user.profile.full_name }}</span>
            <span class="block text-sm text-gray-500 truncate">{{ user.email }}</span>
          </div>
          <ul class="py-2" aria-labelledby="user-menu-button">
            <li>
              <a href="{% url 'profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
            </li>
            <li>
              <a href="{% url 'account_logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a>
            </li>
          </ul>
        </div>

        <!-- Mobile menu button -->
      <button id="mobile-menu-toggle" type="button"
              class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200"
              aria-controls="navbar-user" aria-expanded="false">
          <span class="sr-only">Open main menu</span>
          <span class="material-icons">menu</span>
      </button>
    </div>

    <!-- Main Navigation Links -->
    <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-user">
      <ul class="flex flex-col font-medium p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent">
        <li>
          <a href="{% url 'home' %}" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0">Home</a>
        </li>
        <li>
          <a href="{% url 'my_groups' %}" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0">My Groups</a>
        </li>
        <li>
          <a href="{% url 'contributions_list' %}" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0">Contributions</a>
        </li>

        {% if active_group %}
          <li>
            <a href="{% url 'group_list' %}" 
               class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0">Join Group</a>
          </li>
        {% endif %}
        <li>
          <button onclick="create_group_modal.showModal()"
             class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0">Create Group</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // User Dropdown Toggle
    const userMenuBtn = document.getElementById('user-menu-button');
    const userDropdown = document.getElementById('user-dropdown');
    
    if (userMenuBtn && userDropdown) {
        userMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });
    }

    // Group Switcher Toggle
    const groupSwitcherBtn = document.getElementById('group-switcher-button');
    const groupSwitcherDropdown = document.getElementById('group-switcher-dropdown');
    
    if (groupSwitcherBtn && groupSwitcherDropdown) {
        groupSwitcherBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            groupSwitcherDropdown.classList.toggle('hidden');
            // Close user dropdown if open
            if (userDropdown) userDropdown.classList.add('hidden');
        });

        document.addEventListener('click', function(e) {
            if (!groupSwitcherBtn.contains(e.target) && !groupSwitcherDropdown.contains(e.target)) {
                groupSwitcherDropdown.classList.add('hidden');
            }
        });
    }

    // Mobile Menu Toggle
    const mobileMenuBtn = document.getElementById('mobile-menu-toggle');
    const navbarUser = document.getElementById('navbar-user');

    if (mobileMenuBtn && navbarUser) {
        mobileMenuBtn.addEventListener('click', function() {
            navbarUser.classList.toggle('hidden');
        });
    }
});
</script>


